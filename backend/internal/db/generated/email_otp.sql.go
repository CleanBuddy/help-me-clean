// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: email_otp.sql

package db

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const countActiveEmailOTPs = `-- name: CountActiveEmailOTPs :one
SELECT COUNT(*) FROM email_otp_codes
WHERE email = $1
  AND expires_at > NOW()
  AND used_at IS NULL
`

func (q *Queries) CountActiveEmailOTPs(ctx context.Context, email string) (int64, error) {
	row := q.db.QueryRow(ctx, countActiveEmailOTPs, email)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createEmailOTP = `-- name: CreateEmailOTP :one
INSERT INTO email_otp_codes (email, code, role, expires_at)
VALUES ($1, $2, $3, NOW() + INTERVAL '10 minutes')
RETURNING id, email, code, role, expires_at, used_at, created_at
`

type CreateEmailOTPParams struct {
	Email string `json:"email"`
	Code  string `json:"code"`
	Role  string `json:"role"`
}

func (q *Queries) CreateEmailOTP(ctx context.Context, arg CreateEmailOTPParams) (EmailOtpCode, error) {
	row := q.db.QueryRow(ctx, createEmailOTP, arg.Email, arg.Code, arg.Role)
	var i EmailOtpCode
	err := row.Scan(
		&i.ID,
		&i.Email,
		&i.Code,
		&i.Role,
		&i.ExpiresAt,
		&i.UsedAt,
		&i.CreatedAt,
	)
	return i, err
}

const deleteExpiredEmailOTPs = `-- name: DeleteExpiredEmailOTPs :exec
DELETE FROM email_otp_codes
WHERE expires_at < NOW() - INTERVAL '1 hour'
`

func (q *Queries) DeleteExpiredEmailOTPs(ctx context.Context) error {
	_, err := q.db.Exec(ctx, deleteExpiredEmailOTPs)
	return err
}

const getValidEmailOTP = `-- name: GetValidEmailOTP :one
SELECT id, email, code, role, expires_at, used_at, created_at FROM email_otp_codes
WHERE email = $1
  AND code  = $2
  AND expires_at > NOW()
  AND used_at IS NULL
ORDER BY created_at DESC
LIMIT 1
`

type GetValidEmailOTPParams struct {
	Email string `json:"email"`
	Code  string `json:"code"`
}

func (q *Queries) GetValidEmailOTP(ctx context.Context, arg GetValidEmailOTPParams) (EmailOtpCode, error) {
	row := q.db.QueryRow(ctx, getValidEmailOTP, arg.Email, arg.Code)
	var i EmailOtpCode
	err := row.Scan(
		&i.ID,
		&i.Email,
		&i.Code,
		&i.Role,
		&i.ExpiresAt,
		&i.UsedAt,
		&i.CreatedAt,
	)
	return i, err
}

const markEmailOTPUsed = `-- name: MarkEmailOTPUsed :exec
UPDATE email_otp_codes
SET used_at = NOW()
WHERE id = $1
`

func (q *Queries) MarkEmailOTPUsed(ctx context.Context, id pgtype.UUID) error {
	_, err := q.db.Exec(ctx, markEmailOTPUsed, id)
	return err
}
